---
title: "bartools: import and QC single-cell barcode data"
author: "Henrietta Holze"
output: 
  rmarkdown::html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    highlight: tango 
date: September 05, 2023
vignette: >
  %\VignetteIndexEntry{import-qc-single-cell}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: sentence
---

# TODO
create example dataset: counts.tsv, cell-barcode-anno.tsv, seurat object
add description of example dataset. 


# Import and QC of single-cell barcode data

This vignette shows how to
1. Import the barcode counts table produced by BARtab single-cell workflow
2. Creat QC plots and filter barcodes
3. Add barcode counts to a Seurat object

If filtering has already been performed by BARtab, using `umi_count_filter` and `umi_fraction_filter` parameters, skip to section 2.  
If the QC thresholds need to be revised, follow section 1. 

## 0. Load the `bartools` package

```{r setup}
library(bartools)
knitr::opts_chunk$set(dev="png")
```

## 1. Importing DNA barcode count data

Raw barcode count data can be thought of similarly to raw integer-based count data from other count based experiments such as RNA-sequencing.
For these data types the `edgeR` package provides an efficient `DGEList` object structure to store sample counts and associated metadata.
`bartools` makes use of this object structure to store and process DNA barcode counts.

### An example barcoding experiment

For this section we will make use of a hypothetical DNA barcoding dataset based on recent unpublished data from the Dawson lab investigating the response of acute myeloid leukaemia (AML) cells to a novel class of MYST acetyltransferase inhibitor described recently in [MacPherson et al. Nature 2019](https://dx.doi.org/10.1038/s41586-019-1835-6).

AML cells were cultured *in vitro*, barcoded using a lentiviral based barcoding library called [SPLINTR](https://dx.doi.org/10.1038/s41586-021-04206-7), and transplanted into three groups of C57BL/6J mice with daily dosing of MYST inhibitor at low or high dose or a corresponding vehicle control.

Barcode containing cells were harvested from the bone marrow of diseased mice and sequenced in technical replicate.

To follow along with this vignette the raw counts tables and sample metadata are included in the `bartools` package.

## 1. QC and filtering of barcodes

First, we load the results of BARtab. 

```{r}
# counts_path <- "/researchers/henrietta.holze/splintr_tools/old_bartab/test/test_out/sc/counts/test_sc.counts.tsv"
counts_path <- "../../bartools_sc_example/BARtab_out/counts/unmapped.counts.tsv"
```

```{r}
counts <- readBartabCounts(counts_path)
head(counts)
```

This unfiltered barcode counts table is in long format and potentially has multiple rows per cell ID if multiple barcodes per cell are detected. 

We assess the quality of the data by looking at the number of barcodes detected per cell and the number of UMIs supporting the most frequent barcode per cell. 

```{r}
plotBarcodesPerCell(counts)
```

```{r}
plotUmiPerBarcode(counts)
```

In order to identify a suitable threshold for the minimum number of UMIs supporting a barcode, we can plot the cummulative sum of how many cells would pass each threshold. 

```{r}
plotUmiFilterThresholds(counts)
```

If we would remove barcodes that are supported by a single UMI, we would lose half the cells. Therefore, we do not filter based on minimum number of UMIs.

However, we can remove minor barcodes from cells, i.e. barcodes that have less than half the number of supporting UMIs than the major barcode in the cell. 

```{r}
counts_filtered <- filterBarcodes(counts, umiCountFilter = 1, umiFractionFilter = 0.5)
```

The following plot shows that the number of cells with multiple barcodes detected is now reduced. 

If we would want to keep only the most frequent barcode per cell, we could do so with `umi_fraction_filter = 1`. 
Ties will be kept. 


```{r}
plotBarcodesPerCell(counts_filtered)
```

Finally, we aggregate barcodes per cell by concatenating barcodes and UMIs with `;`.  

```{r}
counts_agg <- aggregateBarcodes(counts_filtered)
head(counts_agg)
```

This allows to add the barcode data into the metadata of a seurat object. 


## 2. Add barcode data to Seurat or SingleCellExperiment object

We can either use the filtered barcode table created above or load the already filtered barcode table generated by BARtab. 


```{r}
data(test.sce)
test.sce
```

## 5. Session Info

```{r}
sessionInfo()
```
